/* Dead Keys */
#define DEAD_KEY_BASE 0x070100
#define DEAD_KEY(i) (DEAD_KEY_BASE + (i))
/* ------------- */

/* Home-Row Mods */
ZMK_HOLD_TAP(hml,
    flavor="balanced";
    tapping-term-ms=<280>;
    quick-tap-ms=<175>;
    require-prior-idle-ms=<130>;
    bindings=<&kp>,<&kp>;
    hold-trigger-key-positions = <KEYS_R THUMBS_L THUMBS_R>;
    hold-trigger-on-release;
)

ZMK_HOLD_TAP(hmr,
    flavor="balanced";
    tapping-term-ms=<280>;
    quick-tap-ms=<175>;
    require-prior-idle-ms=<130>;
    bindings=<&kp>,<&kp>;
    hold-trigger-key-positions = <KEYS_L THUMBS_L THUMBS_R>;
    hold-trigger-on-release;
)

#define HML(mod_key, alpha_key) &hml mod_key alpha_key // HRM Left Hand
#define HMR(mod_key, alpha_key) &hmr mod_key alpha_key // HRM Right Hand
/* ------------- */

/* BT Device Chooser */
ZMK_TAP_DANCE(
    bt_sel,
    tapping-term-ms=<200>;
    bindings=<&bt BT_SEL 0>,<&bt BT_SEL 1>,<&bt BT_SEL 2>;
)
/* ----------- */

/* One-Shot Mods */
ZMK_STICKY_KEY(osm_sk,
    release-after-ms=<3000>;
    bindings=<&kp>;
    quick-release;
    lazy;
    ignore-modifiers;
)

ZMK_HOLD_TAP(osm,
    flavor="balanced";
    tapping-term-ms=<280>;
    bindings=<&kp>,<&osm_sk>;
    hold-while-undecided-linger;
)

#define OSM(keycode) &osm keycode keycode
/* ------------- */

/* Auto Shift */
ZMK_HOLD_TAP(as,
    flavor="tap-preferred";
    tapping-term-ms=<180>;
    bindings=<&kp>,<&kp>;
)

#define AS_1(keycode) &as LS(keycode) keycode
#define AS_2(keycode1, keycode2) &as keycode2 keycode1
/* ------------- */

/* Haptic Feedback */
#define HAPTIC_OBG(node_name, device_ref, force_val) \
    node_name: node_name {                           \
        compatible = "zmk,output-behavior-generic";  \
        #binding-cells = <0>;                        \
        device = <device_ref>;                       \
        force = <force_val>;                         \
    };

#define OUTPUT_SOURCE_LAYER_STATE_CHANGE 1
#define HAPTIC_LAYER(node_name, bindings_list, layers_list)  \
    node_name: node_name {                                   \
        compatible = "zmk,output-behavior-listener";         \
        bindings = bindings_list;                            \
        layers = layers_list;                                \
        sources = <OUTPUT_SOURCE_LAYER_STATE_CHANGE>;        \
        all-state;                                           \
    };

#define OUTPUT_SOURCE_KEYCODE_STATE_CHANGE 3
#define HAPTIC_KEYCODE(node_name, keycode, bindings_list, layers_list) \
    node_name: node_name {                                             \
        compatible = "zmk,output-behavior-listener";                   \
        bindings = bindings_list;                                      \
        position = keycode;                                            \
        layers = layers_list;                                          \
        sources = <OUTPUT_SOURCE_KEYCODE_STATE_CHANGE>;                \
    };

/ {
    HAPTIC_OBG(haptic_click_l, &haptic_l, 1)
    HAPTIC_OBG(haptic_click_r, &haptic_r, 1)
    HAPTIC_OBG(haptic_bump_l, &haptic_l, 7)
    HAPTIC_OBG(haptic_bump_r, &haptic_r, 7)
};
/* ----------- */

/*
Haptic One-Shot Mods

1) Define dead key: #define MY_KEY DEAD_KEY(unique_index)
2) Instantiate HAPTIC_OSM with dead key.
3) Add HAPTIC_KEYCODE listener for the dead key.
4) Use OSML(MOD) / OSMR(MOD) in keymap bindings.
*/

#define HAPTIC_OSM(name, dead_key) \
    ZMK_MACRO_ONE_PARAM(name##_tap,                                                 \
        bindings=<&kp dead_key>,<&macro_param_1to1>,<&osm_sk MACRO_PLACEHOLDER>;    \
    )                                                                               \
    ZMK_HOLD_TAP(name,                                                              \
        flavor="balanced";                                                          \
        tapping-term-ms=<280>;                                                      \
        bindings=<&kp>,<&name##_tap>;                                               \
        hold-while-undecided-linger;                                                \
    )

#define HAPTIC_OSML_KEY DEAD_KEY(0)
#define HAPTIC_OSMR_KEY DEAD_KEY(1)

HAPTIC_OSM(osml, HAPTIC_OSML_KEY)
HAPTIC_OSM(osmr, HAPTIC_OSMR_KEY)

/ {
    HAPTIC_KEYCODE(haptic_osml, <HAPTIC_OSML_KEY>, <&haptic_click_l>, <ALL>)
    HAPTIC_KEYCODE(haptic_osmr, <HAPTIC_OSMR_KEY>, <&haptic_click_r>, <ALL>)
};

#define OSML(keycode) &osml keycode keycode
#define OSMR(keycode) &osmr keycode keycode
/* ----------- */